---
title: "Week 5 Conditional Logistic Regression"
author: "Wayne Enanoria"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
# Show R code in output for all R chunks
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

* Purpose: Code for Week 5 Conditional Logistic Regression Video 
* Data: PHW253_Wk6_CaseControlStudy_redacted_notxt.xlsx


# Preliminary

Call in the necessary R packages for this assignment.

## install packages 
## (just run once and then comment out by adding ## in front of line)
## install.packages("rio")
## install.packages("skimr")
## install.packages("dplyr")
## install.packages("janitor")
## install.packages("survival")

 
###### Step 0: Load packages. Import dataset. Subset the data (all code is provided in Week 4). 
###### For conditional logistic regression, all food item values need to be 0 or 1; recode other values to missing. 
 
```{r}
## load packages
## run everytime

## rio needed for import code
library(rio)
## dplyr needed for mutate or recode
library(dplyr)
## janitor needed for crosstable
library(janitor)
## survival needed for clogit
library(survival)
```

# Data Set

## In Weeks 1-3, we used line listing (a dataset with only the cases)
## In Weeks 4-6, we will use outbreak investigation dataset (a matched case-control study)
```{r}
## import
ecoli <- import("~/PHW253_2022/PHW253_Wk6_CaseControlStudy_redacted_notxt.xlsx")



## look at the dataset 
## example: names(dataset)
dim(ecoli)
names(ecoli)

## janitor package clean names changes the column names to lower case & replaces
## the spaces in column names with an underscore
## example: newnamedataset<- dataset  %>% janitor::clean_names()

ecoli1<- ecoli %>% janitor::clean_names()

```

The data set contains more records than needed for the matched case-control study. Thus, you will have to subset the data in order to get the study data set.

```{r}
## Select only cases that have matched controls
ecoli2 <- ecoli1 %>% 
  filter(cdcid !="CDC001" & cdcid !="CDC006" & cdcid !="CDC009" & cdcid !="CDC012" & 
           cdcid !="CDC015" & cdcid !="CDC022" & cdcid !="CDC023" & cdcid !="CDC024" & 
           cdcid !="CDC037" & cdcid !="CDC043" & cdcid !="CDC045" & cdcid !="CDC046" & 
           cdcid !="CDC048" & cdcid !="CDC049" & cdcid !="CDC067" & cdcid !="CDC068")   

## Some cases have multiple controls
ecoli2 %>%  filter(cdcid == "CDC047")  %>% tabyl(case)

## Only keep controlletter=A for cdcid=="CDC047"
x<-which(ecoli2$cdcid =="CDC047" & ecoli2$controlletter=="B")   
ecoli3 <-ecoli2[-x, ]    

dim(ecoli3)
```



##### For conditional logistic regression, all food item values need to be 0 or 1. 
##### Recode other values to missing. 

```{r}

ecoli3 %>%  tabyl(milk, case)

## milk is the only variable coded as: 0,1,NA
## all other variables have some NAs coded as 99 and/or 3

ecoli3$xrawcd<-ifelse((ecoli3$rawcd==3 | ecoli3$rawcd==99),NA,ecoli3$rawcd)
ecoli3 %>%  tabyl(xrawcd, rawcd)
ecoli3 %>%  tabyl(xrawcd, case)
```


###### Step 1: Need to create a numeric variable that identifies each pair

## this is called strata in the regression code
## first, select last two characters of the CDCID string/character variable (new variable stratachar)
## then, convert to a numeric format (new variable stratanum)

```{r}
ecoli3$stratachar<-substr(ecoli3$cdcid,start=5,stop=6)

ecoli3 %>%  tabyl(stratachar)

ecoli3$stratanum<-as.numeric(ecoli3$stratachar)

ecoli3 %>%  tabyl(stratachar,stratanum)
```



 
##### Step 2: Conidtional logsitic regression.
 
```{r}
clogit(case ~ milk + strata(stratanum), data=ecoli3)
## the exponential of the coefficient "exp(coef)" is the odds ratio of 2.0
```


```{r}
## below is coding trick to output exponentiated 95% CIs
## these are the 95% CI of the odds ratio
m<-clogit(case ~ milk + strata(stratanum), data=ecoli3)
summary(m)
## probability of observing a z-statistic value more extreme than
## the one observed "Pr(>|z|)" is the p-value of 0.57
```



## additional example: raw cookie dough

```{r}
m<-clogit(case ~ xrawcd + strata(stratanum), method="exact", data=ecoli3)
summary(m)
```


```{r}
## if model does not converge, try to change to a non-exact method

m<-clogit(case ~ xrawcd + strata(stratanum), method="approximate", data=ecoli3)
summary(m)

## why does the model (still) not converge? let's look at the data

ecoli3 %>% tabyl(xrawcd, case, cdcid)

```
## column A (xrawcd=0 for control & case): 2
## column B (xrawcd=0 for control, 1 for case): 29
## column C (xrawcd=1 for control, 0 for case): 0
## column D (xrawcd=1 for control & case): 4
## dropped observation/missing exposure info: 1

## OR M-H = b/c
## cannot calculate 29/0

## We can *approximate* OR M-H with small cell adjustment
## = b/(c+1)= (29)/(1)= 29
# this approximation method is from: 
#Small-Sample Bias of Point Estimators of the Odds Ratio from Matched Sets
#Jewell, N. Biometrics, 1984, Vol. 40, No. 2, pp. 421-435
##https://www.jstor.org/stable/2531395

## In practice, we would then use a different regression model made for small cells
## called exact logistic regression. R does not have a currently available
## exact logistic regression package. (The archived elrm package requires
## a collapsed data set; it is not clear how to do so with paired data where the case
## status both defines the discordant/concordant pairs and is the outcome of the model.)

## For raw cookie dough, the matched OR (95% CI) and p-value are provided (obtained from study authors):
## OR: 41.3 
## 95% confidence interval (7.37, >999.99) 
## p-value <0.01


 

 

 




 



